{
	admin 0.0.0.0:2019

	servers {
		client_ip_headers X-Forwarded-For X-Real-IP

		trusted_proxies static private_ranges
		trusted_proxies_strict
	}
}

(default-headers) {
	header {
		Referrer-Policy "strict-origin-when-cross-origin"
		Strict-Transport-Security "max-age=3153600; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Forwarded-Proto "https"
		X-Frame-Options "DENY"
		X-Frame-Options "sameorigin"
		X-Robots-Tag "none,noarchive,nosnippet,notranslate,noimageindex,"
		X-XSS-Protection 1
	}
}

(strict-csp) {
	header {
		Content-Security-Policy "
          default-src 'self' *.{$BASE_DOMAIN};
          frame-ancestors 'none';
          img-src 'self' *.{$BASE_DOMAIN} blob: data:;
          object-src 'none';
          script-src 'self' *.{$BASE_DOMAIN};
          style-src 'self' *.{$BASE_DOMAIN};
      "
	}
}

(unsafe-csp) {
	header {
		Content-Security-Policy "
          default-src https: data: blob:;
          frame-ancestors 'none';
          object-src 'none';
          script-src 'self' *.{$BASE_DOMAIN} 'unsafe-inline';
          style-src 'self' *.{$BASE_DOMAIN} 'unsafe-inline';
      "
	}
}

*.{$BASE_DOMAIN} {
	vars {
		auth_token c96a452527a9d887e30ee9fde1c9256edf857a054fe5d72e79cddc0fbe7074ef
	}

	tls {
		dns cloudflare {env.CLOUDFLARE_API_TOKEN}
		propagation_delay 2m
		resolvers 1.1.1.1
	}

	handle_path /{http.vars.auth_token}* {
		uri strip_prefix /{http.vars.auth_token}
		handle /dns-query* {
			reverse_proxy https://adguard-home:443 {
				transport http {
					tls_insecure_skip_verify
				}

				# For proper client IP tracking:
				header_up Host {upstream_hostport}
				header_up X-Real-IP {http.request.remote.host}
			}
		}

		handle {
			# Requests with valid token but invalid path
			respond "Invalid request" 400
		}
	}

	@13ft host 13ft.{$BASE_DOMAIN}
	handle @13ft {
		import default-headers
		import strict-csp

		reverse_proxy http://13ft:5000
	}

	@agh host adguard-home.{$BASE_DOMAIN}
	handle @agh {
		import default-headers
		import strict-csp

		reverse_proxy http://adguard-home:3000
	}

	@forgejo host forgejo.{$BASE_DOMAIN}
	handle @forgejo {
		import default-headers
		import unsafe-csp

		reverse_proxy http://forgejo-server:3000 {
			health_uri /api/healthz
			health_interval 5s
			health_timeout 10s
			health_status 2xx
		}
	}

	@jellyfin host jellyfin.{$BASE_DOMAIN}
	handle @jellyfin {
		header {
			Content-Security-Policy "
          default-src https: data: blob: ;
          img-src 'self' https://* ;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline' https://www.gstatic.com https://www.youtube.com blob:;
          worker-src 'self' blob:;
          connect-src 'self';
          object-src 'none';
          font-src 'self';
      "
			Strict-Transport-Security "max-age=315360000; includeSubDomains; preload"
			X-Content-Type-Options "nosniff"
			X-Frame-Options "allow-from https://{$BASE_DOMAIN}"
			X-Robots-Tag "noindex,nofollow,nosnippet,noarchive,notranslate,noimageindex"
			X-XSS-Protection 1
		}

		reverse_proxy http://host.docker.internal:8096 {
			health_uri /health
			health_interval 5s
			health_timeout 10s
			health_status 2xx
		}
	}

	@metube host metube.{$BASE_DOMAIN}
	handle @metube {
		import default-headers
		import unsafe-csp

		reverse_proxy http://metube:8081
	}

	@n8n host n8n.{$BASE_DOMAIN}
	handle @n8n {
		import default-headers
		import strict-csp

		reverse_proxy http://n8n:5678
	}

	@omni-tools host omni-tools.{$BASE_DOMAIN}
	handle @omni-tools {
		import default-headers
		import unsafe-csp

		reverse_proxy http://omni-tools:80
	}

	@open-speed-test host openspeedtest.{$BASE_DOMAIN}
	handle @open-speed-test {
		import default-headers
		import strict-csp

		request_body {
			max_size 10GB
		}

		reverse_proxy http://openspeedtest:3000
	}

	@prometheus host prom.{$BASE_DOMAIN}
	handle @prometheus {
		import default-headers
		import strict-csp

		reverse_proxy http://prometheus:9090
	}

	@grafana host grafana.{$BASE_DOMAIN}
	handle @grafana {
		import default-headers
		import strict-csp

		reverse_proxy http://grafana:3000
	}

	@sxng host searxng.{$BASE_DOMAIN}
	handle @sxng {
		import default-headers

		encode zstd gzip

		@api {
			path /config
			path /healthz
			path /stats/errors
			path /stats/checker
		}

		@static {
			path /static/*
		}

		@imageproxy {
			path /image_proxy
		}

		header {
			# CSP (https://content-security-policy.com)
			Content-Security-Policy "upgrade-insecure-requests; default-src 'none'; script-src 'self'; style-src 'self' 'unsafe-inline'; form-action 'self' https:; font-src 'self'; frame-ancestors 'self'; base-uri 'self'; connect-src 'self'; img-src * data:; frame-src https:;"

			# Disable browser features
			Permissions-Policy "accelerometer=(),camera=(),geolocation=(),gyroscope=(),magnetometer=(),microphone=(),payment=(),usb=()"

			# Only allow same-origin requests
			Referrer-Policy "same-origin"

			# Prevent MIME type sniffing from the declared Content-Type
			X-Content-Type-Options "nosniff"

			# Comment header to allow indexing by search engines
			X-Robots-Tag "noindex, nofollow, noarchive, nositelinkssearchbox, nosnippet, notranslate, noimageindex"

			# enable HSTS
			# WARNING: Once this value is set, the site must continue to support HTTPS until the expiry time is reached.

			# Strict-Transport-Security max-age=15768000;

			# Remove "Server" header
			-Server
		}

		header @api {
			Access-Control-Allow-Methods "GET, OPTIONS"
			Access-Control-Allow-Origin "*"
		}

		route {
			# Cache policy
			header Cache-Control "no-cache"
			header @static Cache-Control "public, max-age=30, stale-while-revalidate=60"
			header @imageproxy Cache-Control "public, max-age=3600"
		}

		# SearXNG
		reverse_proxy http://searxng:8080 {
			health_uri /healthz
			health_interval 5s
			health_timeout 10s
			health_status 2xx
		}
	}

	@syncthing host syncthing.{$BASE_DOMAIN}
	handle @syncthing {
		import default-headers

		reverse_proxy https://host.docker.internal:8384 {
			transport http {
				tls_insecure_skip_verify
			}
			header_up Host {upstream_hostport}
		}
	}

	@whoami host whoami.{$BASE_DOMAIN}
	handle @whoami {
		import default-headers

		reverse_proxy http://traefik-whoami:80
	}

	@wud host wud.{$BASE_DOMAIN}
	handle @wud {
		import default-headers
		import strict-csp

		reverse_proxy http://wud:3000
	}
}
